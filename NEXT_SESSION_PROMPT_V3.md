# Prompt para PrÃ³xima SessÃ£o - Maximizar MigraÃ§Ã£o de Cidades

## Contexto

Estou migrando o projeto **Querido DiÃ¡rio** para **Cloudflare Workers** (Node.js + TypeScript). O repositÃ³rio estÃ¡ em https://github.com/qcx/querido-diario-workers.

### Status Atual (Commit 6fb32f5)

- **321 cidades migradas** de 474 (67.7%) âœ…
- **15 classes base implementadas**
- **PrÃ³ximo objetivo: 400+ cidades (84%+)**

### Classes Base Implementadas âœ…

1. âœ… **Instar** - 111 cidades
2. âœ… **DOEM** - 56 cidades
3. âœ… **DOSP** - 42 cidades
4. âœ… **ADiarios V1** - 34 cidades
5. âœ… **DIOF** - 20 cidades (21 no original)
6. âœ… **DiarioOficialBR** - 10 cidades
7. âœ… **Siganet** - 10 cidades
8. âœ… **BarcoDigital** - 7 cidades (12 no original)
9. âœ… **Modernizacao** - 7 cidades
10. âœ… **ADiarios V2** - 5 cidades (com Browser Rendering)
11. âœ… **Aplus** - 4 cidades
12. âœ… **Dioenet** - 4 cidades
13. âœ… **AdministracaoPublica** - 3 cidades
14. âœ… **PTIO** - 3 cidades
15. âœ… **Sigpub** - 3 cidades (implementado mas nÃ£o usado)

### Classes Base Pendentes (Por Prioridade)

| Classe | Cidades | Prioridade | Complexidade | Notas |
|--------|---------|------------|--------------|-------|
| **MunicipioOnline** | 26 | ðŸ”¥ ALTA | MÃ©dia | Form-based, yearly windows |
| **AtendeV2** | 22 | ðŸ”¥ ALTA | MÃ©dia | AJAX pagination, atende.net |
| **Dionet** | 5 | MÃ©dia | Baixa | Similar a outras bases |
| **PortalGov** | 2 | Baixa | Baixa | Poucas cidades |
| **Aratext** | 2 | Baixa | Baixa | Poucas cidades |
| **AdminLte** | 2 | Baixa | Baixa | Poucas cidades |

---

## Objetivo da PrÃ³xima SessÃ£o

**Implementar as 2 classes base de maior impacto: MunicipioOnline (26 cidades) + AtendeV2 (22 cidades)**

### Metas

1. âœ… Implementar **MunicipioOnline Spider** (26 cidades)
2. âœ… Implementar **AtendeV2 Spider** (22 cidades)
3. âœ… Testar com pelo menos 1 cidade de cada
4. âœ… Criar configuraÃ§Ãµes JSON para todas as cidades
5. âœ… Atualizar registry e documentaÃ§Ã£o

### Resultado Esperado

- **369 cidades funcionais** (321 + 48)
- **Cobertura:** 77.8%
- **Salto de +10% em uma sessÃ£o**

---

## InformaÃ§Ãµes TÃ©cnicas

### 1. MunicipioOnline Spider (26 cidades)

**Plataforma:** MunicipioOnline.com.br  
**URL Pattern:** `https://www.municipioonline.com.br/{uf}/prefeitura/{city}/cidadao/diariooficial`

**CaracterÃ­sticas:**
- Form-based submission com ASP.NET ViewState
- Filtro por data com formato DD/MM/YYYY
- Intervalo mÃ¡ximo de 1 ano por request (yearly windows)
- PaginaÃ§Ã£o via POST
- Download direto de PDFs

**Exemplo de cidade:**
- **MaceiÃ³ - AL**: `url_uf: "al"`, `url_city: "maceio"`
- URL: https://www.municipioonline.com.br/al/prefeitura/maceio/cidadao/diariooficial

**Fluxo:**
1. GET inicial para obter pÃ¡gina com form
2. Extrair ViewState e outros campos ASP.NET
3. POST com filtro de data (intervalos de 1 ano)
4. Parse resultados e extrair URLs de PDF
5. Iterar paginaÃ§Ã£o se necessÃ¡rio

**Classe Base Original:**
```python
# ~/querido-diario/data_collection/gazette/spiders/base/municipioonline.py
class BaseMunicipioOnlineSpider(BaseGazetteSpider):
    allowed_domains = ["municipioonline.com.br"]
    
    def start_requests(self):
        url = f"https://www.municipioonline.com.br/{self.url_uf}/prefeitura/{self.url_city}/cidadao/diariooficial"
        yield scrapy.Request(url, callback=self.date_filter_request)
    
    def date_filter_request(self, response):
        # Yearly windows para evitar timeout
        for interval in yearly_window(self.start_date, self.end_date, format="%d/%m/%Y"):
            formdata = {
                "__EVENTTARGET": "ctl00$body$btnBuscaPalavrachave",
                "ctl00$body$txtDtPeriodo": f"{interval.start}-{interval.end}",
            }
            yield scrapy.FormRequest.from_response(response, formdata=formdata)
```

**Cidades que usam MunicipioOnline (26):**
Para encontrar todas: `cd ~/querido-diario/data_collection/gazette/spiders && grep -r "BaseMunicipioOnlineSpider" . --include="*.py" | cut -d: -f1`

---

### 2. AtendeV2 Spider (22 cidades)

**Plataforma:** Atende.net (Layout 2)  
**URL Pattern:** `https://{city_subdomain}.atende.net/diariooficial/edicao/pagina/atende.php`

**CaracterÃ­sticas:**
- AJAX-based com parÃ¢metros GET
- SubdomÃ­nio por cidade
- PaginaÃ§Ã£o numÃ©rica
- Download direto de PDFs
- Filtro por data integrado

**Exemplo de cidade:**
- **Cidade exemplo**: `city_subdomain: "exemplo"`
- URL: https://exemplo.atende.net/diariooficial/edicao/pagina/atende.php

**Fluxo:**
1. GET com parÃ¢metros para pÃ¡gina 1
2. Parse lista de diÃ¡rios (div.nova_listagem div.linha)
3. Extrair data, ediÃ§Ã£o, tipo, URL do PDF
4. Detectar Ãºltima pÃ¡gina
5. Iterar pÃ¡ginas atÃ© completar

**Classe Base Original:**
```python
# ~/querido-diario/data_collection/gazette/spiders/base/atende_v2.py
class BaseAtendeV2Spider(BaseGazetteSpider):
    allowed_domains = ["atende.net"]
    
    def start_requests(self):
        self.BASE_URL = f"https://{self.city_subdomain}.atende.net/diariooficial/edicao/pagina/atende.php"
        yield FormRequest(
            url=self.BASE_URL,
            method="GET",
            formdata=self.get_params("pagina", 1),
            cb_kwargs={"page": 1},
        )
    
    def parse(self, response, page):
        for item in response.css("div.nova_listagem div.linha"):
            date_raw = item.css("div.data::text").get()
            edition_type = item.css("div.tipo::text").get()
            edition_number = item.css("div.titulo::text").re_first(r"\d+")
            download_url = item.css("button::attr(data-link)")[-1].get()
            
            is_extra = bool(re.search(
                r"suplementar|retificaÃ§Ã£o|extraordinÃ¡ria|extra",
                edition_type,
                re.IGNORECASE,
            ))
            
            yield Gazette(...)
        
        if page < self.get_last_page(response):
            yield FormRequest(..., cb_kwargs={"page": page + 1})
    
    def get_params(self, filtro, value):
        return {
            "rot": "54015",
            "aca": "101",
            "ajax": "t",
            "processo": "loadPluginDiarioOficial",
            "filtro": filtro,
            "valor": str(value),
        }
```

**Cidades que usam AtendeV2 (22):**
Para encontrar todas: `cd ~/querido-diario/data_collection/gazette/spiders && grep -r "BaseAtendeV2Spider" . --include="*.py" | cut -d: -f1`

---

## Plano de ImplementaÃ§Ã£o

### Fase 1: MunicipioOnline Spider (1.5h)

1. **Criar arquivo base** `src/spiders/base/municipio-online-spider.ts`
2. **Implementar lÃ³gica:**
   - Fetch inicial da pÃ¡gina do form
   - Extrair ViewState e campos ASP.NET com Cheerio
   - Criar yearly windows (funÃ§Ã£o helper)
   - POST com FormData
   - Parse resultados HTML
   - Extrair URLs de PDF
3. **Criar configuraÃ§Ãµes** `src/spiders/configs/municipio-online-cities.json`
4. **Atualizar registry** para incluir novo spider
5. **Testar** com MaceiÃ³-AL

### Fase 2: AtendeV2 Spider (1.5h)

1. **Criar arquivo base** `src/spiders/base/atende-v2-spider.ts`
2. **Implementar lÃ³gica:**
   - Construir URL com subdomÃ­nio
   - Criar parÃ¢metros GET
   - Parse div.nova_listagem
   - Extrair data, ediÃ§Ã£o, tipo
   - Detectar ediÃ§Ã£o extra (regex)
   - PaginaÃ§Ã£o automÃ¡tica
3. **Criar configuraÃ§Ãµes** `src/spiders/configs/atende-v2-cities.json`
4. **Atualizar registry** para incluir novo spider
5. **Testar** com uma cidade

### Fase 3: Extrair ConfiguraÃ§Ãµes (1h)

1. **Script para extrair configs do repo original:**
   ```bash
   cd ~/querido-diario/data_collection/gazette/spiders
   
   # MunicipioOnline
   grep -r "BaseMunicipioOnlineSpider" . --include="*.py" -A 20 | \
     grep -E "(TERRITORY_ID|url_uf|url_city|start_date)" > /tmp/municipio_configs.txt
   
   # AtendeV2
   grep -r "BaseAtendeV2Spider" . --include="*.py" -A 20 | \
     grep -E "(TERRITORY_ID|city_subdomain|start_date)" > /tmp/atende_configs.txt
   ```

2. **Converter para JSON** seguindo padrÃ£o existente
3. **Validar** todas as configuraÃ§Ãµes

### Fase 4: Testes e ValidaÃ§Ã£o (30min)

1. Testar ambos os spiders localmente
2. Verificar extraÃ§Ã£o de dados
3. Validar contagem de cidades
4. Executar `count-cities.ts`

### Fase 5: DocumentaÃ§Ã£o e Commit (30min)

1. Atualizar README com novas classes
2. Atualizar MIGRATION_PROGRESS.md
3. Commit incremental para cada spider
4. Push para repositÃ³rio

---

## Estrutura de Arquivos

```
src/spiders/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ municipio-online-spider.ts    # NOVO
â”‚   â”œâ”€â”€ atende-v2-spider.ts           # NOVO
â”‚   â””â”€â”€ ...
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ municipio-online-cities.json  # NOVO (26 cidades)
â”‚   â”œâ”€â”€ atende-v2-cities.json         # NOVO (22 cidades)
â”‚   â””â”€â”€ ...
â””â”€â”€ registry.ts                        # ATUALIZAR
```

---

## Tipos TypeScript

### MunicipioOnline Config

```typescript
export interface MunicipioOnlineConfig {
  type: 'municipio_online';
  urlUf: string;        // "al", "ba", etc.
  urlCity: string;      // "maceio", "salvador", etc.
}
```

### AtendeV2 Config

```typescript
export interface AtendeV2Config {
  type: 'atende_v2';
  citySubdomain: string;  // "exemplo", "cidade", etc.
}
```

---

## Helpers NecessÃ¡rios

### Yearly Windows (para MunicipioOnline)

```typescript
// src/utils/date-utils.ts
export function* yearlyWindows(
  startDate: string,
  endDate: string
): Generator<{ start: string; end: string }> {
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  let currentStart = new Date(start);
  
  while (currentStart < end) {
    const currentEnd = new Date(currentStart);
    currentEnd.setFullYear(currentEnd.getFullYear() + 1);
    currentEnd.setDate(currentEnd.getDate() - 1);
    
    if (currentEnd > end) {
      currentEnd.setTime(end.getTime());
    }
    
    yield {
      start: formatDateBR(currentStart),
      end: formatDateBR(currentEnd),
    };
    
    currentStart.setFullYear(currentStart.getFullYear() + 1);
  }
}

function formatDateBR(date: Date): string {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}
```

---

## Comandos Ãšteis

```bash
# Clonar repositÃ³rio
cd ~
gh repo clone qcx/querido-diario-workers
cd querido-diario-workers

# Instalar dependÃªncias
npm install

# Build
npm run build

# Extrair configuraÃ§Ãµes do repo original
cd ~/querido-diario/data_collection/gazette/spiders

# Listar cidades MunicipioOnline
grep -r "BaseMunicipioOnlineSpider" . --include="*.py" | cut -d: -f1 | sort

# Listar cidades AtendeV2
grep -r "BaseAtendeV2Spider" . --include="*.py" | cut -d: -f1 | sort

# Ver exemplo de config
cat sp/sp_sao_paulo.py

# Contar cidades apÃ³s implementaÃ§Ã£o
cd ~/querido-diario-workers
npx tsx count-cities.ts
```

---

## Script de ExtraÃ§Ã£o de ConfiguraÃ§Ãµes

```typescript
// extract-configs.ts
import * as fs from 'fs';
import * as path from 'path';

interface CityConfig {
  id: string;
  name: string;
  territoryId: string;
  spiderType: string;
  startDate: string;
  config: any;
}

// Parse Python spider files and extract configs
// Implementar parser para extrair:
// - TERRITORY_ID
// - url_uf, url_city (MunicipioOnline)
// - city_subdomain (AtendeV2)
// - start_date
// - name
```

---

## Checklist de ImplementaÃ§Ã£o

### MunicipioOnline
- [ ] Criar `municipio-online-spider.ts`
- [ ] Implementar `crawl()` method
- [ ] Implementar yearly windows helper
- [ ] Implementar ASP.NET ViewState extraction
- [ ] Implementar form submission
- [ ] Implementar parse de resultados
- [ ] Criar `municipio-online-cities.json` (26 cidades)
- [ ] Atualizar registry
- [ ] Testar com MaceiÃ³-AL
- [ ] Commit

### AtendeV2
- [ ] Criar `atende-v2-spider.ts`
- [ ] Implementar `crawl()` method
- [ ] Implementar construÃ§Ã£o de URL
- [ ] Implementar parÃ¢metros GET
- [ ] Implementar parse de div.nova_listagem
- [ ] Implementar detecÃ§Ã£o de ediÃ§Ã£o extra
- [ ] Implementar paginaÃ§Ã£o
- [ ] Criar `atende-v2-cities.json` (22 cidades)
- [ ] Atualizar registry
- [ ] Testar com uma cidade
- [ ] Commit

### DocumentaÃ§Ã£o
- [ ] Atualizar README
- [ ] Atualizar MIGRATION_PROGRESS.md
- [ ] Atualizar count-cities.ts se necessÃ¡rio
- [ ] Criar SESSION_SUMMARY com resultados
- [ ] Push final

---

## ReferÃªncias

- **RepositÃ³rio Workers:** https://github.com/qcx/querido-diario-workers
- **RepositÃ³rio Original:** https://github.com/okfn-brasil/querido-diario
- **MunicipioOnline Base:** `~/querido-diario/data_collection/gazette/spiders/base/municipioonline.py`
- **AtendeV2 Base:** `~/querido-diario/data_collection/gazette/spiders/base/atende_v2.py`

---

## Prompt Resumido para Copiar

```
OlÃ¡! Estou continuando a migraÃ§Ã£o do Querido DiÃ¡rio para Cloudflare Workers.

RepositÃ³rio: https://github.com/qcx/querido-diario-workers
Status: 321 cidades migradas (67.7%)
Ãšltimo commit: 6fb32f5

Objetivo: Implementar as 2 classes base de maior impacto:
1. MunicipioOnline Spider (26 cidades)
2. AtendeV2 Spider (22 cidades)

Meta: 369 cidades (77.8%) - salto de +10% em uma sessÃ£o!

Detalhes completos em: ~/querido-diario-workers/NEXT_SESSION_PROMPT_V3.md

Por favor:
1. Implemente MunicipioOnline Spider
2. Implemente AtendeV2 Spider
3. Extraia todas as configuraÃ§Ãµes do repo original
4. Teste com pelo menos 1 cidade de cada
5. FaÃ§a commits incrementais
6. NÃƒO faÃ§a deploy

Obrigado!
```

---

**Criado em:** 04/10/2025  
**Ãšltima atualizaÃ§Ã£o:** Commit 6fb32f5  
**Tempo estimado:** 4-5 horas  
**Prioridade:** ðŸ”¥ MUITO ALTA  
**Complexidade:** MÃ©dia-Alta  
**Impacto:** +48 cidades (+10% cobertura)
